This repo contains scripts and utilities for analyzing tandem repeats (TRs). 

## Installation

To install the latest version using pip, run:

```
python3 -m pip install --upgrade str-analysis@git+https://github.com/broadinstitute/str-analysis
```

or use the docker image (though it may not have the latest version of the code):

```
docker run -it weisburd/str-analysis:latest
```

## Tools

  * **call_non_ref_motifs** ([docs](https://github.com/broadinstitute/str-analysis/blob/main/docs/call_non_ref_motifs.md)) - takes a BAM/CRAM file and, optionally, an ExpansionHunter variant catalog. For each locus, it determines which STR motifs are supported by reads overlapping that locus before running ExpansionHunter on the motif(s) it detected. Useful for detecting non-reference pathogenic motifs (e.g., RFC1).
  * **filter_vcf_to_tandem_repeats** - newer iteration of *filter_vcf_to_STR_variants*. Takes a VCF (single-sample or multi-sample) and filters it to insertions and deletions that represent tandem repeat expansions or contractions. Uses both brute-force k-mer search for perfect repeats and TandemRepeatFinder for imperfect repeats (VNTRs). Separates locus discovery from genotyping for more flexible downstream analysis.
  * **filter_vcf_to_STR_variants** - original version of the above tool. Takes a single-sample VCF file and filters it to the INS/DEL variants that represent tandem repeat expansions or contractions by performing brute-force k-mer search on each variant's inserted or deleted bases. This tool was a core part of [Weisburd, B., Tiao, G. & Rehm, H. L. Insights from a genome-wide truth set of tandem repeat variation. (2023)](https://www.biorxiv.org/content/10.1101/2023.05.05.539588v1)
  * **merge_loci** - takes one or more STR catalogs and combines them into a single catalog while removing
    duplicates based on overlap and repeat motif. 
  * **annotate_and_filter_str_catalog** - takes an STR catalog and annotates the loci based on their overlap with genes  
    and known disease associated STRs. It then allows filtering by motif size, gene region, and various other criteria.
  * **compute_catalog_stats** - takes an annotated catalog output by the *annotate_and_filter_str_catalog* script and 
    computes various summary statistics about it.
  * **add_offtarget_regions** - takes an ExpansionHunter variant catalog and adds a list of off-target regions to each
    locus definition by querying a database of off-target regions that have been precomputed for each TR motif.
    This database was generated by using wgsim to simulate fully-repetitive reads for each motif, and then recording
    where these reads mapped on hg19 and hg38 after aligning them using bwa. 
  * **add_adjacent_loci_to_expansion_hunter_catalog** - takes an ExpansionHunter variant catalog and a BED file containing all simple repeats in the reference genome. Outputs a new catalog with updated LocusStructures and ReferenceRegions that include any adjacent repeats found near each locus in the input catalog.
  * **split_adjacent_loci_in_expansion_hunter_catalog** - splits loci with adjacent repeats back into separate loci.
  * **check_trios_for_mendelian_violations** - takes a table of combined ExpansionHunter calls generated by the `combine_str_json_to_tsv` as well as a FAM or PED file with parent/child relationships, and outputs a table of mendelian violations in the callset.
  * **simulate_str_expansions** - uses [wgsim](https://github.com/hammer/wgsim) to generate BAM files with simulated read data containing STR expansions at a given locus, with specified number of repeats, motif, zygosity, etc.
  * **filter_out_loci_with_Ns_in_flanks** - removes loci from an ExpansionHunter catalog if their flanks contain enough Ns to trigger an ExpansionHunter error.


* ExpansionHunterDenovo output post-processing:
  * **annotate_EHdn_locus_outliers** - takes an ExpansionHunterDenovo outlier result table (locus outliers or case-control) as well as a BED file containing all simple repeats in the reference genome and, optionally, a gene models GTF file, a variant catalog of known disease-associated loci, and/or other BED files with genomic regions of interest. Outputs a new table where each EHdn outlier is annotated with multiple columns related to the provided reference data.
  * **convert_annotated_EHdn_locus_outliers_to_expansion_hunter_catalog** - takes the output table from **annotate_EHdn_locus_outliers** and lets the user apply a range of filters before writing out the passing loci to an ExpansionHunter variant catalog.


* gnomAD STR calls:
  * **generate_gnomad_json** - was used to combine the gnomAD STR calls into the files
    available for [download on the gnomAD website](https://gnomad.broadinstitute.org/downloads#v3-short-tandem-repeats).


* post-process and combine ExpansionHunter outputs:
  * **combine_str_json_to_tsv** - takes a set of ExpansionHunter JSON output files and combines them into a single TSV table.
  * **filter_to_largest_expansions** - takes a combined table of TR genotypes (from *combine_str_json_to_tsv*) and filters it to the N most expanded genotypes per locus, based on either the long allele or the short allele (for recessive searches). Optionally filters by quality score, purity, and can discard non-polymorphic loci.
  * **combine_json_to_tsv** - takes a set of arbitrary JSON files that share the same schema and combines their top-level fields into a single TSV file.
  * **combine_lps_to_allele_histograms** - takes one or more tables of LPS (likelihood per sample) scores and combines them into per-locus allele histograms. Useful for aggregating genotype data across large cohorts.
  * **copy_EH_vcf_fields_to_json** - takes the ExpansionHunter output VCF and JSON file for a given sample and copies fields that are only present in the VCF to the JSON file.
  * **run_reviewer** - takes ExpansionHunter output files for a single sample and runs REViewer on the subset of loci where the genotypes exceed locus-specific thresholds specified in the variant catalog.
  * **make_bamlet** - optimized version of ExpansionHunterDenovo's make-bamlet.py. For a given STR region, extracts all relevant reads from a BAM or CRAM file into a much smaller BAMlet which can be used as input to ExpansionHunter instead of the full BAM/CRAM but yield the same genotype. Reduces I/O operations for better performance. 

* format converters:
  * **convert_bed_to_expansion_hunter_catalog** - converts BED files to ExpansionHunter variant catalog format
  * **convert_expansion_hunter_catalog_to_gangstr_spec** - converts ExpansionHunter catalogs to GangSTR spec format
  * **convert_expansion_hunter_catalog_to_hipstr_format** - converts ExpansionHunter catalogs to HipSTR format
  * **convert_expansion_hunter_catalog_to_trgt_catalog** - converts ExpansionHunter catalogs to TRGT catalog format
  * **convert_expansion_hunter_catalog_to_longtr_format** - converts ExpansionHunter catalogs to LongTR format
  * **convert_expansion_hunter_catalog_to_vamos_catalog** - converts ExpansionHunter catalogs to VAMOS catalog format
  * **convert_expansion_hunter_catalog_to_bed** - converts ExpansionHunter catalogs to BED format
  * **convert_gangstr_spec_to_expansion_hunter_catalog** - converts GangSTR spec to ExpansionHunter variant catalog
  * **convert_trgt_catalog_to_expansion_hunter_catalog** - converts TRGT repeat catalog BED files to ExpansionHunter variant catalog JSON format
  * **convert_expansion_hunter_denovo_locus_tsv_to_bed** - converts ExpansionHunterDenovo locus TSV to BED format
  * **convert_gangstr_vcf_to_expansion_hunter_json** - converts GangSTR VCF output to ExpansionHunter JSON format
  * **convert_hipstr_vcf_to_expansion_hunter_json** - converts HipSTR VCF output to ExpansionHunter JSON format
  * **convert_trgt_vcf_to_expansion_hunter_json** - converts TRGT VCF output to ExpansionHunter JSON format
  * **convert_straglr_bed_to_expansion_hunter_json** - converts Straglr BED output to ExpansionHunter JSON format
  * **convert_strling_calls_to_expansion_hunter_json** - converts STRling calls to ExpansionHunter JSON format


